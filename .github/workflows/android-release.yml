name: Android Release

on:
  # Tag è§¦å‘ï¼ˆæŽ¨èï¼‰
  push:
    tags:
      - 'android-v*'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¯é€‰æŒ‡å®šç‰ˆæœ¬ï¼‰
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 1.0.2)ï¼Œç•™ç©ºåˆ™ä»Ž package.json è¯»å–'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release å’ŒæŽ¨é€ä»£ç 

    steps:
      - name: Checkout android branch
        uses: actions/checkout@v4
        with:
          ref: android  # å§‹ç»ˆä»Ž android åˆ†æ”¯æž„å»º

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Build web assets (without CDN)
        run: DISABLE_CDN=true pnpm build

      - name: Debug - Check generated data
        run: |
          echo "=== Checking public/data directory ==="
          ls -la public/data/ || echo "public/data not found"
          ls -la public/data/mobile/ || echo "public/data/mobile not found"
          ls -la public/data/desktop/ || echo "public/data/desktop not found"
          ls -la dist/data/ || echo "dist/data not found"
          ls -la dist/data/mobile/ || echo "dist/data/mobile not found"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/wallpaper-gallery.keystore

      - name: Create keystore.properties
        run: |
          cat > android/keystore.properties << EOF
          storeFile=wallpaper-gallery.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=wallpaper
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Build Release APK
        working-directory: android
        run: ./gradlew assembleRelease

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.version }}" ]; then
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬
            VERSION="${{ inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/android-v* ]]; then
            # Tag è§¦å‘æ—¶ä»Ž tag æå–ç‰ˆæœ¬
            VERSION="${GITHUB_REF#refs/tags/android-v}"
          else
            # ä»Ž package.json è¯»å–ç‰ˆæœ¬
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Build version: $VERSION"

      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/release/*.apk Wallpaper-Gallery-v${{ steps.get_version.outputs.VERSION }}.apk

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-v${{ steps.get_version.outputs.VERSION }}
          files: Wallpaper-Gallery-v${{ steps.get_version.outputs.VERSION }}.apk
          name: Android v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Wallpaper Gallery Android v${{ steps.get_version.outputs.VERSION }}

            ### ä¸‹è½½
            ç‚¹å‡»ä¸‹æ–¹ APK æ–‡ä»¶ä¸‹è½½å®‰è£…

            ### æ›´æ–°å†…å®¹
            - è¯·æŸ¥çœ‹ commit è®°å½•
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update app-version.json
        run: |
          mkdir -p public
          cat > public/app-version.json << EOF
          {
            "version": "${{ steps.get_version.outputs.VERSION }}",
            "versionCode": $(node -p "const v='${{ steps.get_version.outputs.VERSION }}'.split('.'); v[0]*10000+v[1]*100+Number(v[2])"),
            "downloadUrl": "https://github.com/${{ github.repository }}/releases/download/android-v${{ steps.get_version.outputs.VERSION }}/Wallpaper-Gallery-v${{ steps.get_version.outputs.VERSION }}.apk",
            "changelog": "ç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }} å‘å¸ƒ",
            "releaseDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Commit app-version.json to android branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/app-version.json
          git diff --cached --quiet || git commit -m "chore: update app-version.json to v${{ steps.get_version.outputs.VERSION }}"
          git push origin HEAD:android
