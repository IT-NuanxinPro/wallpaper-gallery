name: Deploy to GitHub Pages

on:
  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [main]

  # å®šæ—¶è§¦å‘ï¼šæ¯å¤© UTC 18:00ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥ 02:00ï¼‰- ä½å³°æœŸ,å›¾åºŠåŒæ­¥å 2 å°æ—¶éƒ¨ç½²
  schedule:
    - cron: '0 18 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½® GITHUB_TOKEN æƒé™
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥æ›´æ–° package.json ç‰ˆæœ¬å·
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save original commit message
        id: commit_msg
        run: |
          # ä¿å­˜åŸå§‹æäº¤ä¿¡æ¯ï¼ˆåœ¨ç‰ˆæœ¬é€’å¢ä¹‹å‰ï¼‰
          COMMIT_MSG=$(git log -1 --pretty=format:"%B")
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Auto-increment version
        id: version
        run: |
          # è¯»å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "ğŸ“¦ Current version: $CURRENT_VERSION"

          # è§£æç‰ˆæœ¬å· (major.minor.patch)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # é€’å¢ patch ç‰ˆæœ¬
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          echo "ğŸš€ New version: $NEW_VERSION"

          # æ›´æ–° package.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf-8'));
            pkg.version = '$NEW_VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # éªŒè¯æ›´æ–°
          echo "âœ… Updated package.json:"
          grep '"version"' package.json

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Get latest CDN version from nuanXinProPic
        id: cdn_version
        run: |
          # ä½¿ç”¨ GitHub API è·å–å›¾åºŠä»“åº“çš„æœ€æ–° tag
          LATEST_TAG=$(curl -s "https://api.github.com/repos/IT-NuanxinPro/nuanXinProPic/tags" | jq -r '.[0].name // "v1.0.4"')

          # å¦‚æœ API è¿”å›ç©ºæˆ–é”™è¯¯ï¼Œä½¿ç”¨å¤‡ç”¨é»˜è®¤å€¼
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            LATEST_TAG="v1.0.4"
            echo "âš ï¸ Failed to get tag from API, using fallback: $LATEST_TAG"
          else
            echo "âœ… Got latest CDN version: $LATEST_TAG"
          fi

          echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Update CDN version in constants.js
        run: |
          CDN_VERSION="${{ steps.cdn_version.outputs.version }}"
          echo "ğŸ“¦ Updating CDN_VERSION to: $CDN_VERSION"

          # ä½¿ç”¨ sed æ›¿æ¢ç‰ˆæœ¬å·
          sed -i "s/export const CDN_VERSION = '[^']*'/export const CDN_VERSION = '$CDN_VERSION'/" src/utils/constants.js

          # éªŒè¯æ›¿æ¢ç»“æœ
          echo "âœ… Updated constants.js:"
          grep "CDN_VERSION" src/utils/constants.js

      - name: Checkout nuanXinProPic (wallpaper source)
        uses: actions/checkout@v4
        with:
          repository: IT-NuanxinPro/nuanXinProPic
          path: nuanXinProPic
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Copy data from image repository
        run: |
          # å¤åˆ¶å›¾åºŠä»“åº“ä¸­å·²ç”Ÿæˆçš„ data ç›®å½•
          # è¿™äº›æ•°æ®ç”± workflow çš„ process-metadata.js ç”Ÿæˆï¼ŒåŒ…å« AI å…ƒæ•°æ®
          # æ³¨æ„ï¼šåªå¤åˆ¶ desktop/mobile/avatarï¼Œä¸è¦†ç›– statsï¼ˆçƒ­é—¨æ•°æ®ï¼‰
          mkdir -p public/data
          if [ -d "nuanXinProPic/data" ]; then
            echo "ğŸ“¦ Copying data from nuanXinProPic/data..."
            
            # åªå¤åˆ¶ç‰¹å®šç³»åˆ—ï¼Œé¿å…è¦†ç›– stats
            for series in desktop mobile avatar; do
              if [ -d "nuanXinProPic/data/$series" ]; then
                echo "  Copying $series..."
                cp -r "nuanXinProPic/data/$series" public/data/
              fi
              if [ -f "nuanXinProPic/data/$series.json" ]; then
                echo "  Copying $series.json..."
                cp "nuanXinProPic/data/$series.json" public/data/
              fi
            done
            
            echo "âœ… Data copied successfully"

            # å¤åˆ¶ Bing æ•°æ®ï¼ˆBing ä½¿ç”¨ç‹¬ç«‹çš„ meta ç›®å½•ï¼‰
            if [ -d "nuanXinProPic/bing/meta" ]; then
              echo "ğŸ“¦ Copying Bing data from nuanXinProPic/bing/meta..."
              mkdir -p public/data/bing
              cp -r nuanXinProPic/bing/meta/* public/data/bing/
              echo "âœ… Bing data copied successfully"
            fi

            ls -la public/data/
          else
            echo "âš ï¸ nuanXinProPic/data not found, running generate-data.js as fallback"
            pnpm generate
          fi

      - name: Build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: pnpm build

      - name: Commit version update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet package.json; then
            echo "ğŸ“¦ No version changes to commit"
          else
            git add package.json
            git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]"
            git push
            echo "âœ… Version ${{ steps.version.outputs.version }} committed"
          fi

      - name: Create Git tag and Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="v${{ steps.version.outputs.version }}"
          
          # æ£€æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "âš ï¸ Tag $VERSION already exists, skipping"
          else
            # ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„åŸå§‹æäº¤ä¿¡æ¯
            COMMIT_MSG="${{ steps.commit_msg.outputs.commit_msg }}"
            
            # åˆ›å»ºå¹¶æ¨é€ tag
            git tag -a "$VERSION" -m "$COMMIT_MSG"
            git push origin "$VERSION"
            echo "âœ… Created and pushed tag: $VERSION"
            
            # ä½¿ç”¨ GitHub CLI åˆ›å»º release
            gh release create "$VERSION" \
              --title "$VERSION" \
              --notes "$COMMIT_MSG" \
              --latest
            
            echo "âœ… Created release: $VERSION"
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Purge Cloudflare cache
        if: success()
        run: |
          echo "ğŸ§¹ Purging Cloudflare cache..."

          # æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼ˆç¡®ä¿ /data/ ç›®å½•çš„ JSON ä¹Ÿè¢«æ¸…é™¤ï¼‰
          RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}')

          # æ£€æŸ¥å“åº”
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… Successfully purged all Cloudflare cache"
          else
            echo "âš ï¸ Cache purge response: $RESPONSE"
          fi
