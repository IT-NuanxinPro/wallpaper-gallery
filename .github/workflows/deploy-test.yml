name: Deploy Test to Cloudflare Pages

on:
  # æ¨é€åˆ°æµ‹è¯•åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [test, develop]
  
  # PR åˆ°æµ‹è¯•åˆ†æ”¯æ—¶è§¦å‘é¢„è§ˆéƒ¨ç½²
  pull_request:
    branches: [test]

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½® GITHUB_TOKEN æƒé™
permissions:
  contents: read
  pull-requests: write  # ç”¨äº PR è¯„è®º
  deployments: write    # ç”¨äºéƒ¨ç½²çŠ¶æ€

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "test-pages-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: test
      url: https://test-wallpaper.061129.xyz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest CDN version from nuanXinProPic
        id: cdn_version
        run: |
          # ä½¿ç”¨ GitHub API è·å–å›¾åºŠä»“åº“çš„æœ€æ–° tag
          LATEST_TAG=$(curl -s "https://api.github.com/repos/IT-NuanxinPro/nuanXinProPic/tags" | jq -r '.[0].name // "v1.0.4"')

          # å¦‚æœ API è¿”å›ç©ºæˆ–é”™è¯¯ï¼Œä½¿ç”¨å¤‡ç”¨é»˜è®¤å€¼
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
            LATEST_TAG="v1.0.4"
            echo "âš ï¸ Failed to get tag from API, using fallback: $LATEST_TAG"
          else
            echo "âœ… Got latest CDN version: $LATEST_TAG"
          fi

          echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Update CDN version in constants.js
        run: |
          CDN_VERSION="${{ steps.cdn_version.outputs.version }}"
          echo "ğŸ“¦ Updating CDN_VERSION to: $CDN_VERSION"

          # ä½¿ç”¨ sed æ›¿æ¢ç‰ˆæœ¬å·
          sed -i "s/export const CDN_VERSION = '[^']*'/export const CDN_VERSION = '$CDN_VERSION'/" src/utils/constants.js

          # éªŒè¯æ›¿æ¢ç»“æœ
          echo "âœ… Updated constants.js:"
          grep "CDN_VERSION" src/utils/constants.js

      - name: Checkout nuanXinProPic (wallpaper source)
        uses: actions/checkout@v4
        with:
          repository: IT-NuanxinPro/nuanXinProPic
          path: nuanXinProPic
          fetch-depth: 1

      - name: Restore file timestamps from backup
        run: |
          cd nuanXinProPic

          # ä¼˜å…ˆä½¿ç”¨å®Œæ•´å¤‡ä»½æ–‡ä»¶ï¼ˆåŒ…å«æ‰€æœ‰ä¸‰ä¸ªç³»åˆ—ï¼‰
          if [ -f "timestamps-backup-all.txt" ]; then
            echo "âœ… Found timestamps-backup-all.txt, restoring all file timestamps..."

            # ä½¿ç”¨å®Œæ•´å¤‡ä»½æ–‡ä»¶æ¢å¤æ—¶é—´æˆ³
            chmod +x scripts/restore-timestamps.sh
            BACKUP_FILE=timestamps-backup-all.txt ./scripts/restore-timestamps.sh

            echo "âœ… All file timestamps restored from backup"
          elif [ -f "timestamps-backup.txt" ]; then
            echo "âœ… Found timestamps-backup.txt, restoring desktop file timestamps..."

            # ä½¿ç”¨æ—§çš„å¤‡ä»½æ–‡ä»¶ï¼ˆä»… desktopï¼‰
            chmod +x scripts/restore-timestamps.sh
            ./scripts/restore-timestamps.sh

            echo "âœ… Desktop file timestamps restored from backup"
          else
            echo "âš ï¸ No timestamps backup file found, skipping timestamp restoration"
          fi

          # éªŒè¯ï¼šæ˜¾ç¤ºå‡ ä¸ªæ–‡ä»¶çš„æ—¶é—´
          echo "ğŸ“… Sample file timestamps:"
          echo "Desktop:"
          ls -lh wallpaper/desktop/åŠ¨æ¼«/äºŒæ¬¡å…ƒ/ 2>/dev/null | head -3 || echo "Desktop directory not found"
          echo "Mobile:"
          ls -lh wallpaper/mobile/åŠ¨æ¼«/ 2>/dev/null | head -3 || echo "Mobile directory not found"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install ImageMagick (for image dimensions)
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Build
        run: pnpm build

      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: wallpaper-gallery-test
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.head_ref || github.ref_name }}

      - name: Output deployment info
        run: |
          echo "ğŸš€ Deployment successful!"
          echo "ğŸ“± URL: ${{ steps.deploy.outputs.url }}"
          echo "ğŸŒ Environment: ${{ steps.deploy.outputs.environment }}"
          echo "ğŸ“¦ Deployment ID: ${{ steps.deploy.outputs.id }}"

      - name: Add PR comment with preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ steps.deploy.outputs.url }}';
            const environment = '${{ steps.deploy.outputs.environment }}';
            const deploymentId = '${{ steps.deploy.outputs.id }}';
            
            const comment = `## ğŸš€ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼
            
            | é¡¹ç›® | ä¿¡æ¯ |
            |------|------|
            | ğŸ“± é¢„è§ˆé“¾æ¥ | ${deployUrl} |
            | ğŸŒ è‡ªå®šä¹‰åŸŸå | https://test-wallpaper.061129.xyz |
            | ğŸ·ï¸ ç¯å¢ƒ | ${environment} |
            | ğŸ“¦ éƒ¨ç½² ID | \`${deploymentId}\` |
            | â° éƒ¨ç½²æ—¶é—´ | ${new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})} |
            
            ### ğŸ“‹ æœ¬æ¬¡éƒ¨ç½²åŒ…å«çš„æ›´æ”¹
            - âœ¨ å¤´åƒè‡ªåˆ¶å·¥å…·åŠŸèƒ½
            - ğŸ¨ UI/UX ä¼˜åŒ–
            - âš¡ æ€§èƒ½æ”¹è¿›
            - ğŸ› Bug ä¿®å¤
            
            ### ğŸ” æµ‹è¯•å»ºè®®
            - [ ] æ£€æŸ¥å¤´åƒåˆ¶ä½œåŠŸèƒ½
            - [ ] éªŒè¯å“åº”å¼å¸ƒå±€
            - [ ] æµ‹è¯•å›¾ç‰‡ä¸Šä¼ å’Œè£å‰ª
            - [ ] ç¡®è®¤ä¸‹è½½åŠŸèƒ½æ­£å¸¸
            
            ---
            ğŸ’¡ **æç¤º**: é¢„è§ˆé“¾æ¥ä¼šåœ¨ PR åˆå¹¶åè‡ªåŠ¨æ¸…ç†`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Create deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ steps.deploy.outputs.url }}' || 'https://test-wallpaper.061129.xyz';
            const state = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: state,
              environment_url: deployUrl,
              description: state === 'success' ? 'éƒ¨ç½²æˆåŠŸ' : 'éƒ¨ç½²å¤±è´¥'
            });
