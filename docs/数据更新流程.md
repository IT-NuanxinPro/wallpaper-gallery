# 壁纸数据更新流程

## 架构概览

```
图床仓库更新 → Web 定时部署 → Electron 检查更新 → 下载最新数据
```

## 三层版本管理

### 1. Web 版本 (main 分支)
- **版本号来源**: `package.json` 的 `version` 字段
- **版本文件**: `public/version.json`
- **更新机制**: 
  - 手动推送到 main 分支
  - 每天 UTC 18:00 定时部署（北京时间次日 02:00）
- **工作流**: `.github/workflows/deploy.yml`

### 2. Electron 应用版本 (feature/desktop-app 分支)
- **版本号来源**: `package.json` 的 `electronVersion` 字段
- **版本文件**: `public/electron-version.json`
- **更新机制**: 
  - 修改 `electronVersion` → 推送代码 → 手动打 tag → GitHub Actions 自动构建
- **工作流**: `.github/workflows/build-electron.yml`
- **检查方式**: 应用启动时对比本地版本和远程 `electron-version.json`

### 3. 壁纸数据版本 ⭐️
- **版本号来源**: 复用 Web 的 `version.json`（图床版本号）
- **检查方式**: 从 `https://wallpaper.061129.xyz/version.json` 获取
- **更新方式**: 从 `https://wallpaper.061129.xyz/data/` 下载数据
- **版本参数**: 使用 `?v=v{version}` 格式（如 `?v=v1.1.52`）

## 数据更新详细流程

### 步骤 1: 图床仓库更新
- 仓库: `IT-NuanxinPro/nuanXinProPic`
- 触发: 推送新壁纸 → 自动打 tag（如 `v1.1.52`）
- 工作流: 生成 JSON 数据文件到 `data/` 目录

### 步骤 2: Web 定时部署
- 仓库: `IT-NuanxinPro/wallpaper-gallery` (main 分支)
- 触发: 每天 UTC 18:00 自动运行
- 工作流: `.github/workflows/deploy.yml`
- 操作:
  1. 从图床仓库获取最新 tag（如 `v1.1.52`）
  2. 更新 `src/utils/constants.js` 中的 `CDN_VERSION`
  3. 复制图床的 `data/` 目录到 `public/data/`
  4. 构建并部署到 `https://wallpaper.061129.xyz`
  5. 更新 `version.json` 中的版本号和构建时间

### 步骤 3: Electron 检查更新
- 时机: 应用启动后 3 秒 + 每小时检查一次
- 文件: `src/composables/useElectronUpdate.js`
- 操作:
  1. 获取 `https://wallpaper.061129.xyz/version.json`
  2. 对比本地存储的 `wallpaper_data_version`
  3. 如果版本号更新，显示更新通知

### 步骤 4: 下载最新数据
- 触发: 用户点击"立即更新"按钮
- 文件: `electron/main.js` 的 `update-wallpaper-data` 处理函数
- 操作:
  1. 获取 Web 的 `version.json`，提取版本号（如 `2.10.0`）
  2. 构造 CDN 版本参数 `v{version}`（如 `v2.10.0`）
  3. 下载所有数据文件（带版本参数）:
     - 主文件: `desktop.json`, `mobile.json`, `avatar.json`
     - 分类文件: `desktop/index.json`, `desktop/{分类}.json`
     - Bing 数据: `bing/index.json`, `bing/2026.json`
     - 热门数据: `stats/hot.json`（可选）
  4. 保存到应用资源目录
  5. 更新本地版本号到 localStorage
  6. 提示用户重启应用

## 数据下载示例

```javascript
// 基础 URL
const baseUrl = 'https://wallpaper.061129.xyz/data'

// 版本参数（从 Web 的 version.json 获取）
const cdnVersion = 'v2.10.0'

// 下载 URL 示例
`${baseUrl}/desktop.json?v=${cdnVersion}`
// → https://wallpaper.061129.xyz/data/desktop.json?v=v2.10.0

`${baseUrl}/mobile/创意.json?v=${cdnVersion}`
// → https://wallpaper.061129.xyz/data/mobile/创意.json?v=v2.10.0

`${baseUrl}/bing/2026.json?v=${cdnVersion}`
// → https://wallpaper.061129.xyz/data/bing/2026.json?v=v2.10.0
```

## 关键设计决策

### 为什么不使用 GitHub API 获取 tag？
- ❌ 网络不稳定，可能被墙
- ❌ 需要处理 API 限流
- ✅ 复用 Web 定时部署机制更可靠

### 为什么不使用 jsDelivr CDN？
- ❌ 单文件 50MB 限制
- ❌ 缓存策略复杂
- ✅ 用户自己的域名速度快、稳定

### 为什么复用 Web 版本号？
- ✅ Web 定时部署会自动同步图床最新数据
- ✅ 版本号与数据内容保持一致
- ✅ 简化版本管理逻辑

### 为什么需要版本参数 `?v=`？
- ✅ 破坏浏览器缓存，确保下载最新数据
- ✅ 与 Web 版本保持一致的缓存策略
- ✅ 避免下载到旧数据

## 文件结构

```
wallpaper-gallery/
├── package.json                          # 包含 version 和 electronVersion
├── public/
│   ├── version.json                      # Web 版本信息
│   ├── electron-version.json             # Electron 版本信息
│   └── data/                             # 壁纸数据（构建时复制）
│       ├── desktop.json
│       ├── mobile.json
│       ├── avatar.json
│       ├── desktop/
│       │   ├── index.json
│       │   └── {分类}.json
│       ├── mobile/
│       ├── avatar/
│       ├── bing/
│       │   ├── index.json
│       │   └── 2026.json
│       └── stats/
│           └── hot.json
├── src/
│   ├── utils/constants.js                # CDN_VERSION 定义
│   └── composables/
│       └── useElectronUpdate.js          # 更新检查逻辑
├── electron/
│   └── main.js                           # 数据下载逻辑
└── .github/workflows/
    ├── deploy.yml                        # Web 部署（不要修改）
    └── build-electron.yml                # Electron 构建
```

## 常见问题

### Q: Web 版本更新了，Electron 会自动更新吗？
A: 不会。Electron 应用版本独立管理，需要手动打 tag 触发构建。

### Q: 图床更新了，Electron 数据会自动更新吗？
A: 不会自动更新，但会检测到更新并提示用户。用户点击"立即更新"后会下载最新数据。

### Q: 为什么要重启应用才能看到新数据？
A: 数据文件在应用启动时加载到内存，需要重启才能重新加载。

### Q: 如何手动触发数据更新？
A: 应用内会显示更新通知，点击"立即更新"按钮即可。

### Q: 数据下载失败怎么办？
A: 检查网络连接，确保可以访问 `https://wallpaper.061129.xyz`。

## 维护指南

### 更新 Web 版本
1. 修改 `package.json` 的 `version`
2. 推送到 main 分支
3. 等待自动部署完成

### 更新 Electron 应用
1. 修改 `package.json` 的 `electronVersion`
2. 推送到 feature/desktop-app 分支
3. 打 tag: `git tag v1.0.1 && git push origin v1.0.1`
4. 等待 GitHub Actions 自动构建

### 更新壁纸数据
1. 推送新壁纸到图床仓库
2. 图床自动打 tag
3. 等待 Web 定时部署（每天 UTC 18:00）
4. Electron 应用会自动检测到更新

## 总结

这套架构的核心思想是：
- **分离关注点**: 应用版本和数据版本独立管理
- **复用机制**: 利用 Web 定时部署自动同步图床数据
- **用户友好**: 自动检测更新，用户手动确认下载
- **稳定可靠**: 使用自己的域名，避免第三方服务限制
