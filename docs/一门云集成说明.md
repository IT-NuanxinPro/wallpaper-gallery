# 一门云 JS Bridge 集成说明

本项目已成功集成一门云的 JS Bridge，支持在一门云 App 环境中使用原生功能。

## 功能特性

### 1. 环境检测
- 自动检测是否在一门云 App 环境中运行
- 检测 JS Bridge 是否准备就绪
- 提供环境状态的响应式数据

### 2. 图片保存功能
- **保存到相册**: 使用原生 API 将图片保存到系统相册
- **下载到应用目录**: 将图片下载到应用的私有存储目录
- **混合模式**: 同时保存到相册和应用目录

### 3. 文件系统操作
- 创建目录
- 检查文件是否存在
- 获取文件大小
- 删除文件
- 列出目录内容

### 4. 权限管理
- 检查存储权限状态
- 请求存储权限
- 引导用户到设置页面

### 5. 用户交互
- 显示 Toast 提示
- 获取设备信息

### 6. 隐私协议管理
- **检查协议状态**: 检查用户是否已同意隐私协议
- **显示协议弹窗**: 显示用户协议与隐私政策窗口
- **显示用户协议**: 单独显示用户协议
- **显示隐私政策**: 单独显示隐私政策
- **设置协议状态**: 通知 App 用户已同意或拒绝协议
- **监听协议变化**: 监听用户协议状态变化
- **退出应用**: 安全退出应用

## 使用方法

### 1. 基础环境检测

```javascript
import { useYimenApp } from '@/composables/useYimenApp'

const { inApp, isAppEnvironment, isBridgeReady } = useYimenApp()

// inApp: 是否在 App 环境且 Bridge 已就绪
// isAppEnvironment: 是否在一门云 App 环境
// isBridgeReady: JS Bridge 是否准备就绪
```

### 2. 使用下载按钮组件

```vue
<template>
  <DownloadButton
    :wallpaper="wallpaperData"
    download-mode="album"  <!-- album | app | both -->
    size="lg"
    variant="primary"
    @download-success="handleSuccess"
    @download-error="handleError"
  />
</template>

<script setup>
import DownloadButton from '@/components/common/DownloadButton.vue'

const wallpaperData = {
  id: 'test-001',
  filename: '壁纸.jpg',
  url: 'https://example.com/image.jpg'
}

function handleSuccess(wallpaper) {
  console.log('下载成功:', wallpaper.filename)
}

function handleError(error) {
  console.error('下载失败:', error)
}
</script>
```

### 3. 直接使用工具函数

```javascript
import { 
  saveImageToAlbum, 
  downloadImageToAppDir,
  getDownloadedWallpapers,
  showToast,
  checkAgreementStatus,
  showAgreement,
  setAgreementStatus
} from '@/utils/yimenBridge'

// 保存图片到相册
const result = await saveImageToAlbum(imageUrl, filename)
if (result.success) {
  showToast(result.message)
}

// 下载到应用目录
const appResult = await downloadImageToAppDir(imageUrl, filename)

// 获取已下载的文件列表
const filesResult = await getDownloadedWallpapers()
console.log('已下载文件:', filesResult.files)

// 检查隐私协议状态
const agreed = await checkAgreementStatus()
if (!agreed) {
  // 显示协议弹窗
  const userAgreed = await showAgreement()
  if (userAgreed) {
    // 用户同意，通知 App
    await setAgreementStatus(true)
  }
}
```

## 文件结构

```
src/
├── utils/
│   └── yimenBridge.js          # 一门云 JS Bridge 工具函数
├── composables/
│   └── useYimenApp.js          # 环境检测 Composable
├── components/
│   └── common/
│       └── DownloadButton.vue  # 智能下载按钮组件
└── views/
    └── demo/
        └── YimenAppDemo.vue    # 功能测试页面
```

## 测试页面

访问 `/yimen-demo` 路径可以打开功能测试页面，包含：

1. **环境状态显示**: 显示当前运行环境、权限状态和协议状态
2. **功能测试按钮**: 测试各项 JS Bridge 功能
3. **下载按钮演示**: 演示不同下载模式的效果
4. **文件管理**: 查看和管理已下载的文件
5. **隐私协议测试**: 测试协议相关功能
6. **测试结果**: 实时显示测试结果和错误信息

## 权限要求

在 Android 环境中，需要以下权限：
- `WRITE_EXTERNAL_STORAGE`: 保存图片到相册和外部存储

应用会自动检查和请求必要的权限。

## 兼容性

- **一门云 App 环境**: 完整功能支持
- **浏览器环境**: 自动回退到传统下载方式
- **移动端浏览器**: 支持基本的文件下载

## 注意事项

1. 所有异步操作都有错误处理和超时机制
2. 在非 App 环境中会自动回退到浏览器下载
3. 文件保存路径为 `fs://file/wallpapers/`
4. 支持常见图片格式：JPG、PNG、GIF、WebP 等
5. 建议在实际使用前先测试权限状态
6. **重要**: 如果启用了隐私协议插件但未设置自动弹出，请务必调用 `setAgreementStatus(true)` 通知 App 用户已同意，否则部分功能可能不可用
7. 隐私协议功能目前仅支持 Android 版本

## 开发调试

1. 在浏览器中访问 `/yimen-demo` 进行基础测试
2. 在一门云 App 中访问相同页面进行完整功能测试
3. 查看控制台输出了解详细的执行过程
4. 使用测试结果面板查看操作结果

## API 参考

详细的 API 文档请参考：
- [一门云官方文档](https://www.yimenapp.com/doc/demo.cshtml)
- [文件系统 API](https://www.yimenapp.com/doc/demo_fs.cshtml)